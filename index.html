<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ç–µ–º–ø–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Telegram Games API -->
  <script src="https://telegram.org/js/games.js"></script>
  <style>
    :root{
      --bg1:#667eea;
      --bg2:#764ba2;
      --card-bg:#ffffff;
      --text:#1f2a44;
      --muted:#5b6b8b;
      --accent:#6a68ff;
      --success:#22c55e;
      --warn:#f59e0b;
      --error:#ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.15);
      --radius:16px;
      --radius-sm:12px;
      --gap:14px;
    }
 
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      min-height:100vh;
      display:grid;
      place-items:center;
      padding:16px;
      overflow-x:hidden;
 
      background-image: url("https://cdnn11.img.sputnik.by/img/103010/81/1030108143_4:0:1275:719_2072x0_60_0_0_3fec56bf337ef2b54e1a34d5d95141f0.jpg");
      background-size: cover;
      background-position: center center;
      background-repeat: no-repeat;
    }
 
    .card{
      width:min(720px, 100%);
      background:var(--card-bg);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding: clamp(18px, 3.6vw, 28px);
      animation:fadeIn .6s ease both;
    }
    @keyframes fadeIn{
      from{opacity:0; transform:translateY(8px)}
      to{opacity:1; transform:translateY(0)}
    }
 
    .header{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:6px;
    }
    .title{
      font-size: clamp(18px, 4.2vw, 22px);
      font-weight:700;
      letter-spacing:0.2px;
    }
    .subtitle{
      color:var(--muted);
      font-size: clamp(12px, 3.4vw, 14px);
      margin-bottom:14px;
    }
 
    form{
      display:grid;
      gap: clamp(12px, 3.2vw, 18px);
    }
 
    .field{
      background:#f7f8fc;
      border-radius:var(--radius-sm);
      padding:14px 14px 10px;
      border:1px solid transparent;
      transition: border-color .2s ease, background .2s ease, box-shadow .2s ease;
    }
    .field:focus-within{
      border-color:#e0e4ff;
      background:#fff;
      box-shadow:0 6px 20px rgba(102,126,234,.12);
    }
 
    label{
      display:flex; align-items:center; gap:10px;
      font-weight:600;
      margin-bottom:8px;
      font-size:14px;
    }
    .inputs{
      display:grid;
      grid-template-columns: repeat(6, minmax(0,1fr));
      gap:10px;
    }
 
    .row-1 .inputs{grid-template-columns: 1fr;}
    .row-2 .inputs{grid-template-columns: 1fr 1fr;}
    .row-3 .inputs{grid-template-columns: 1fr 1fr 1fr;}
 
    .inputs .group{
      display:flex; align-items:center; gap:8px;
      background:#fff;
      border:1px solid #e9ecf7;
      border-radius:10px;
      padding:8px 10px;
      transition: border-color .2s ease, box-shadow .2s ease, transform .12s ease;
    }
    .inputs .group:focus-within{
      border-color:#cfd7ff;
      box-shadow:0 4px 14px rgba(102,126,234,.14);
      transform: translateY(-1px);
    }
    .inputs .group span.sep{
      color:#a3acc1; font-weight:600; user-select:none;
    }
 
    input{
      width:100%;
      border:none;
      outline:none;
      font-size:16px;
      background:transparent;
      color:var(--text);
    }
    input[type="number"]{
      -moz-appearance:textfield;
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
 
    .message{
      min-height:20px;
      font-size:13px;
      color:var(--warn);
      display:flex; align-items:center; gap:8px;
      opacity:.95;
      transition: color .2s ease;
    }
    .message.error{ color:var(--error); }
    .message.ok{ color:var(--success); }
 
    .footer{
      display:flex; flex-direction:column; gap:10px;
      margin-top:6px;
    }
    .btn{
      appearance:none;
      border:none;
      border-radius:14px;
      padding:14px 18px;
      background: linear-gradient(135deg, #7c6cf9, #6a68ff);
      color:#fff; font-weight:700;
      font-size:16px;
      cursor:pointer;
      box-shadow: 0 10px 26px rgba(106,104,255, .28);
      transition: transform .12s ease, box-shadow .2s ease, filter .2s ease;
    }
    .btn:active{ transform: translateY(1px) scale(.997); }
    .btn:hover{ filter:brightness(1.03); box-shadow:0 12px 30px rgba(106,104,255,.34); }
 
    .btn-secondary{
      background:#f4f5fb;
      color:var(--muted);
      box-shadow:none;
    }
    .btn-secondary:hover{
      filter:none;
      box-shadow:0 4px 12px rgba(0,0,0,.06);
    }
 
    .hint{
      font-size:12px; color:#8b94ae; text-align:center;
    }
 
    @media (max-width:560px){
      .inputs{ gap:8px; }
      .inputs .group{ padding:10px 10px; }
      input{ font-size:15px; }
    }
  </style>
</head>
<body>
  <main class="card" role="main" aria-label="–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ç–µ–º–ø–∞">
    <div class="header">
      <div class="title">üèä‚Äç‚ôÄÔ∏èüö¥üèÉ‚Äç‚ôÇÔ∏è–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ç–µ–º–ø–∞</div>
    </div>
    <div class="subtitle">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ª—é–±—ã–µ –¥–≤–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ ‚Äî –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ—Å—á–∏—Ç–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
 
    <form id="calc" autocomplete="off">
      <!-- –î–∏—Å—Ç–∞–Ω—Ü–∏—è -->
      <section class="field row-1">
        <label for="distance"><span>üìè</span> –î–∏—Å—Ç–∞–Ω—Ü–∏—è (–∫–º)</label>
        <div class="inputs">
          <div class="group" title="–î–∏—Å—Ç–∞–Ω—Ü–∏—è, –∫–º">
            <input id="distance" type="text" inputmode="decimal" placeholder="0.00" aria-label="–î–∏—Å—Ç–∞–Ω—Ü–∏—è, –∫–º" />
          </div>
        </div>
      </section>
 
      <!-- –í—Ä–µ–º—è: —á:–º:—Å -->
      <section class="field row-3">
        <label><span>‚è±</span> –í—Ä–µ–º—è (—á—á:–º–º:—Å—Å)</label>
        <div class="inputs">
          <div class="group">
            <input id="hours" type="number" inputmode="numeric" min="0" step="1" placeholder="—á—á" aria-label="–ß–∞—Å—ã" />
          </div>
          <div class="group">
            <input id="minutes" type="number" inputmode="numeric" min="0" max="59" step="1" placeholder="–º–º" aria-label="–ú–∏–Ω—É—Ç—ã" />
          </div>
          <div class="group">
            <input id="seconds" type="number" inputmode="numeric" min="0" max="59" step="1" placeholder="—Å—Å" aria-label="–°–µ–∫—É–Ω–¥—ã" />
          </div>
        </div>
      </section>
 
      <!-- –¢–µ–º–ø 100–º: –º:—Å -->
      <section class="field row-2">
        <label><span>üèä‚Äç‚ôÄÔ∏è</span> –¢–µ–º–ø –Ω–∞ 100–º (–º–∏–Ω:—Å–µ–∫)</label>
        <div class="inputs">
          <div class="group">
            <input id="p100_min" type="number" inputmode="numeric" min="0" max="59" step="1" placeholder="–º–∏–Ω" aria-label="–ú–∏–Ω—É—Ç—ã –Ω–∞ 100–º" />
            <span class="sep">:</span>
            <input id="p100_sec" type="number" inputmode="numeric" min="0" max="59" step="1" placeholder="—Å–µ–∫" aria-label="–°–µ–∫—É–Ω–¥—ã –Ω–∞ 100–º" />
          </div>
        </div>
      </section>
 
      <!-- –¢–µ–º–ø –∫–º: –º:—Å -->
      <section class="field row-2">
        <label><span>üèÉ‚Äç‚ôÇÔ∏èüö¥</span> –¢–µ–º–ø –Ω–∞ 1–∫–º (–º–∏–Ω:—Å–µ–∫)</label>
        <div class="inputs">
          <div class="group">
            <input id="pkm_min" type="number" inputmode="numeric" min="0" max="59" step="1" placeholder="–º–∏–Ω" aria-label="–ú–∏–Ω—É—Ç—ã –Ω–∞ –∫–º" />
            <span class="sep">:</span>
            <input id="pkm_sec" type="number" inputmode="numeric" min="0" max="59" step="1" placeholder="—Å–µ–∫" aria-label="–°–µ–∫—É–Ω–¥—ã –Ω–∞ –∫–º" />
          </div>
        </div>
      </section>
 
      <!-- –°–∫–æ—Ä–æ—Å—Ç—å –∫–º/—á -->
      <section class="field row-1">
        <label for="speed"><span>‚ö°</span> –°–∫–æ—Ä–æ—Å—Ç—å (–∫–º/—á)</label>
        <div class="inputs">
          <div class="group">
            <input id="speed" type="text" inputmode="decimal" placeholder="0.00" aria-label="–°–∫–æ—Ä–æ—Å—Ç—å, –∫–º/—á" />
          </div>
        </div>
      </section>
 
      <div id="msg" class="message" aria-live="polite"></div>
 
      <div class="footer">
        <button type="button" class="btn" id="done">‚úÖ –ì–æ—Ç–æ–≤–æ</button>
        <button type="button" class="btn btn-secondary" id="clear">üîÑ –û—á–∏—Å—Ç–∏—Ç—å</button>
        <div class="hint">–í—Å–µ –ø–æ–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ. –î–ª—è —Ä–∞—Å—á—ë—Ç–∞ —É–∫–∞–∂–∏—Ç–µ –º–∏–Ω–∏–º—É–º 2 –ø–∞—Ä–∞–º–µ—Ç—Ä–∞.</div>
      </div>
    </form>
  </main>
 
 <script>
  const BACKEND_URL = "https://pacecalculator-chernaletski.amvera.io/pace-result";

  function getQueryParams() {
    const params = {};
    const query = window.location.search.substring(1);
    if (!query) return params;
    for (const part of query.split("&")) {
      const [key, value] = part.split("=");
      if (!key) continue;
      params[decodeURIComponent(key)] = value ? decodeURIComponent(value) : "";
    }
    return params;
  }

  const tgContext = getQueryParams();
  console.log("Telegram context:", tgContext);

  function closeGameWebView() {
    try {
      if (window.TelegramGameProxy && typeof TelegramGameProxy.close === "function") {
        TelegramGameProxy.close();
        return;
      }
      if (window.Telegram && Telegram.WebApp && typeof Telegram.WebApp.close === "function") {
        Telegram.WebApp.close();
        return;
      }
      console.log("Not inside Telegram, webview close skipped");
    } catch (e) {
      console.error("Failed to close webview", e);
    }
  }

  let isUpdating = false;
  let lastEdited = null; // 'D' | 'T' | 'P100' | 'PKM' | 'V'

  const el = {
    distance: document.getElementById("distance"),
    hours: document.getElementById("hours"),
    minutes: document.getElementById("minutes"),
    seconds: document.getElementById("seconds"),
    p100_min: document.getElementById("p100_min"),
    p100_sec: document.getElementById("p100_sec"),
    pkm_min: document.getElementById("pkm_min"),
    pkm_sec: document.getElementById("pkm_sec"),
    speed: document.getElementById("speed"),
    msg: document.getElementById("msg"),
    done: document.getElementById("done"),
    clear: document.getElementById("clear"),
  };

  console.log("Form elements:", el);

  const num = (v) => {
    if (v === "" || v === null || v === undefined) return null;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  };

  function sanitizeIntInput(input, min, max) {
    let v = input.value.trim();
    v = v.replace(/[^\d]/g, "");
    if (v === "") {
      input.value = "";
      return null;
    }
    let n = parseInt(v, 10);
    if (!Number.isFinite(n)) {
      input.value = "";
      return null;
    }
    if (min !== undefined && n < min) n = min;
    if (max !== undefined && n > max) n = max;
    input.value = String(n);
    return n;
  }

  function sanitizeDecimalInput(input, min) {
    let v = input.value.trim();
    if (!v) {
      input.value = "";
      return null;
    }
    v = v.replace(",", ".");
    const parts = v.split(".");
    if (parts.length > 2) {
      v = parts[0] + "." + parts.slice(1).join("");
    }
    v = v.replace(/[^0-9.]/g, "");
    input.value = v;
    const n = parseFloat(v);
    if (!Number.isFinite(n)) return null;
    if (min !== undefined && n < min) return null;
    return n;
  }

  function readState() {
    const D = sanitizeDecimalInput(el.distance, 0);

    const hhRaw = sanitizeIntInput(el.hours, 0, 999);
    const mmRaw = sanitizeIntInput(el.minutes, 0, 59);
    const ssRaw = sanitizeIntInput(el.seconds, 0, 59);
    const hasAnyTime = hhRaw !== null || mmRaw !== null || ssRaw !== null;
    const hh = hhRaw ?? 0;
    const mm = mmRaw ?? 0;
    const ss = ssRaw ?? 0;
    const Tsec = hasAnyTime ? hh * 3600 + mm * 60 + ss : null;

    const p100mRaw = sanitizeIntInput(el.p100_min, 0, 59);
    const p100sRaw = sanitizeIntInput(el.p100_sec, 0, 59);
    const hasP100 = p100mRaw !== null || p100sRaw !== null;
    const p100m = p100mRaw ?? 0;
    const p100s = p100sRaw ?? 0;
    const P100 = hasP100 ? p100m * 60 + p100s : null;

    const pkmMRaw = sanitizeIntInput(el.pkm_min, 0, 59);
    const pkmSRaw = sanitizeIntInput(el.pkm_sec, 0, 59);
    const hasPKM = pkmMRaw !== null || pkmSRaw !== null;
    const pkmM = pkmMRaw ?? 0;
    const pkmS = pkmSRaw ?? 0;
    const PKM = hasPKM ? pkmM * 60 + pkmS : null;

    const V = sanitizeDecimalInput(el.speed, 0);

    return {
      D,
      Tsec,
      P100,
      PKM,
      V,
      hasD: D !== null,
      hasT: Tsec !== null,
      hasP100,
      hasPKM,
      hasV: V !== null,
    };
  }

  // –¥–∞–ª—å—à–µ –≤–µ—Å—å —Ç–≤–æ–π compute/setDistance/setTime/... –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô

  function setDistance(D) { /* –∫–∞–∫ —É —Ç–µ–±—è */ }
  function setTime(Tsec) { /* –∫–∞–∫ —É —Ç–µ–±—è */ }
  function setP100(seconds) { /* –∫–∞–∫ —É —Ç–µ–±—è */ }
  function setPKM(seconds) { /* –∫–∞–∫ —É —Ç–µ–±—è */ }
  function setSpeed(V) { /* –∫–∞–∫ —É —Ç–µ–±—è */ }
  function showMsg(text, type = "") { /* –∫–∞–∫ —É —Ç–µ–±—è */ }
  function compute() { /* –∫–∞–∫ —É —Ç–µ–±—è */ }

  function onEdit(category) {
    lastEdited = category;
    compute();
  }

  // –ë–µ–∑–æ–ø–∞—Å–Ω–æ –Ω–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
  el.distance && el.distance.addEventListener("input", () => onEdit("D"));

  [el.hours, el.minutes, el.seconds].forEach((i) =>
    i && i.addEventListener("input", () => onEdit("T"))
  );

  [el.p100_min, el.p100_sec].forEach((i) =>
    i && i.addEventListener("input", () => onEdit("P100"))
  );

  [el.pkm_min, el.pkm_sec].forEach((i) =>
    i && i.addEventListener("input", () => onEdit("PKM"))
  );

  el.speed && el.speed.addEventListener("input", () => onEdit("V"));

  el.clear &&
    el.clear.addEventListener("click", () => {
      isUpdating = true;
      [
        el.distance,
        el.hours,
        el.minutes,
        el.seconds,
        el.p100_min,
        el.p100_sec,
        el.pkm_min,
        el.pkm_sec,
        el.speed,
      ].forEach((inp) => inp && (inp.value = ""));
      lastEdited = null;
      isUpdating = false;
      showMsg("");
    });

  el.done &&
    el.done.addEventListener("click", async () => {
      const s = readState();
      const count = ["hasD", "hasT", "hasP100", "hasPKM", "hasV"].reduce(
        (acc, k) => acc + (s[k] ? 1 : 0),
        0
      );
      if (count < 2) {
        alert("–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º—É–º –¥–≤–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π.");
        return;
      }

      const chatId =
        tgContext.chat_id && tgContext.chat_id !== "None"
          ? Number(tgContext.chat_id)
          : tgContext.user_id && tgContext.user_id !== "None"
          ? Number(tgContext.user_id)
          : null;

      const messageId =
        tgContext.message_id && tgContext.message_id !== "None"
          ? Number(tgContext.message_id)
          : null;

      const userId =
        tgContext.user_id && tgContext.user_id !== "None"
          ? Number(tgContext.user_id)
          : null;

      const result = {
        distanceKm: s.D ?? null,
        time: (() => {
          if (!s.hasT) return null;
          const t = s.Tsec;
          const hh = Math.floor(t / 3600);
          const mm = Math.floor((t % 3600) / 60);
          const ss = t % 60;
          return {
            hours: hh,
            minutes: mm,
            seconds: ss,
            totalSeconds: t,
          };
        })(),
        pace100m: s.hasP100
          ? {
              minutes: Math.floor(s.P100 / 60),
              seconds: s.P100 % 60,
              totalSeconds: s.P100,
            }
          : null,
        pacePerKm: s.hasPKM
          ? {
              minutes: Math.floor(s.PKM / 60),
              seconds: s.PKM % 60,
              totalSeconds: s.PKM,
            }
          : null,
        speedKmh: s.V ?? null,
        timestamp: new Date().toISOString(),
        chat_id: chatId,
        message_id: messageId,
        user_id: userId,
      };

      console.log("–û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –Ω–∞ backend:", result);

      try {
        const resp = await fetch(BACKEND_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(result),
        });

        const data = await resp.json().catch(() => ({}));
        console.log("–û—Ç–≤–µ—Ç backend:", data);

        if (!resp.ok || data.status !== "ok") {
          throw new Error("Backend error: " + JSON.stringify(data));
        }

        if (window.TelegramGameProxy || (window.Telegram && Telegram.WebApp)) {
          closeGameWebView();
        } else {
          alert("–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —á–∞—Ç ‚úÖ");
        }
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ backend:", e);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –ø–æ–∑–∂–µ.");
      }
    });

  compute();
</script>
</body>
</html>

