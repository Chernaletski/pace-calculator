<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ç–µ–º–ø–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Telegram Mini Apps API -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å Games API, –æ–Ω –Ω–µ –º–µ—à–∞–µ—Ç —Ä–∞–±–æ—Ç–µ Mini App, –Ω–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω) -->
  <script src="https://telegram.org/js/games.js"></script>
  <style>
    :root{
      --bg1:#667eea;
      --bg2:#764ba2;
      --card-bg:#ffffff;
      --text:#1f2a44;
      --muted:#5b6b8b;
      --accent:#6a68ff;
      --success:#22c55e;
      --warn:#f59e0b;
      --error:#ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.15);
      --radius:16px;
      --radius-sm:12px;
      --gap:14px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      min-height:100vh;
      display:grid;
      place-items:center;
      padding:16px;
      overflow-x:hidden;

      background-image: url("https://cdnn11.img.sputnik.by/img/103010/81/1030108143_4:0:1275:719_2072x0_60_0_0_3fec56bf337ef2b54e1a34d5d95141f0.jpg");
      background-size: cover;
      background-position: center center;
      background-repeat: no-repeat;
    }

    .card{
      width:min(720px, 100%);
      background:var(--card-bg);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding: clamp(18px, 3.6vw, 28px);
      animation:fadeIn .6s ease both;
    }
    @keyframes fadeIn{
      from{opacity:0; transform:translateY(8px)}
      to{opacity:1; transform:translateY(0)}
    }

    .header{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:6px;
    }
    .title{
      font-size: clamp(18px, 4.2vw, 22px);
      font-weight:700;
      letter-spacing:0.2px;
    }
    .subtitle{
      color:var(--muted);
      font-size: clamp(12px, 3.4vw, 14px);
      margin-bottom:14px;
    }

    form{
      display:grid;
      gap: clamp(12px, 3.2vw, 18px);
    }

    .field{
      background:#f7f8fc;
      border-radius:var(--radius-sm);
      padding:14px 14px 10px;
      border:1px solid transparent;
      transition: border-color .2s ease, background .2s ease, box-shadow .2s ease;
    }
    .field:focus-within{
      border-color:#e0e4ff;
      background:#fff;
      box-shadow:0 6px 20px rgba(102,126,234,.12);
    }

    label{
      display:flex; align-items:center; gap:10px;
      font-weight:600;
      margin-bottom:8px;
      font-size:14px;
    }
    .inputs{
      display:grid;
      grid-template-columns: repeat(6, minmax(0,1fr));
      gap:10px;
    }

    .row-1 .inputs{grid-template-columns: 1fr;}
    .row-2 .inputs{grid-template-columns: 1fr 1fr;}
    .row-3 .inputs{grid-template-columns: 1fr 1fr 1fr;}

    .inputs .group{
      display:flex; align-items:center; gap:8px;
      background:#fff;
      border:1px solid #e9ecf7;
      border-radius:10px;
      padding:8px 10px;
      transition: border-color .2s ease, box-shadow .2s ease, transform .12s ease;
    }
    .inputs .group:focus-within{
      border-color:#cfd7ff;
      box-shadow:0 4px 14px rgba(102,126,234,.14);
      transform: translateY(-1px);
    }
    .inputs .group span.sep{
      color:#a3acc1; font-weight:600; user-select:none;
    }

    input{
      width:100%;
      border:none;
      outline:none;
      font-size:16px;
      background:transparent;
      color:var(--text);
    }
    input[type="number"]{
      -moz-appearance:textfield;
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }

    .message{
      min-height:20px;
      font-size:13px;
      color:var(--warn);
      display:flex; align-items:center; gap:8px;
      opacity:.95;
      transition: color .2s ease;
    }
    .message.error{ color:var(--error); }
    .message.ok{ color:var(--success); }

    .footer{
      display:flex; flex-direction:column; gap:10px;
      margin-top:6px;
    }
    .btn{
      appearance:none;
      border:none;
      border-radius:14px;
      padding:14px 18px;
      background: linear-gradient(135deg, #7c6cf9, #6a68ff);
      color:#fff; font-weight:700;
      font-size:16px;
      cursor:pointer;
      box-shadow: 0 10px 26px rgba(106,104,255, .28);
      transition: transform .12s ease, box-shadow .2s ease, filter .2s ease;
    }
    .btn:active{ transform: translateY(1px) scale(.997); }
    .btn:hover{ filter:brightness(1.03); box-shadow:0 12px 30px rgba(106,104,255,.34); }

    .btn-secondary{
      background:#f4f5fb;
      color:var(--muted);
      box-shadow:none;
    }
    .btn-secondary:hover{
      filter:none;
      box-shadow:0 4px 12px rgba(0,0,0,.06);
    }

    .hint{
      font-size:12px; color:#8b94ae; text-align:center;
    }

    @media (max-width:560px){
      .inputs{ gap:8px; }
      .inputs .group{ padding:10px 10px; }
      input{ font-size:15px; }
    }
  </style>
</head>
<body>
  <main class="card" role="main" aria-label="–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ç–µ–º–ø–∞">
    <div class="header">
      <div class="title">üèä‚Äç‚ôÄÔ∏èüö¥üèÉ‚Äç‚ôÇÔ∏è–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ç–µ–º–ø–∞</div>
    </div>
    <div class="subtitle">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ª—é–±—ã–µ –¥–≤–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ ‚Äî –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ—Å—á–∏—Ç–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>

    <form id="calc" autocomplete="off">
      <!-- –î–∏—Å—Ç–∞–Ω—Ü–∏—è -->
      <section class="field row-1">
        <label for="distance"><span>üìè</span> –î–∏—Å—Ç–∞–Ω—Ü–∏—è (–∫–º)</label>
        <div class="inputs">
          <div class="group" title="–î–∏—Å—Ç–∞–Ω—Ü–∏—è, –∫–º">
            <input id="distance" type="text" inputmode="decimal" placeholder="0.00" aria-label="–î–∏—Å—Ç–∞–Ω—Ü–∏—è, –∫–º" />
          </div>
        </div>
      </section>

      <!-- –í—Ä–µ–º—è: —á:–º:—Å -->
      <section class="field row-3">
        <label><span>‚è±</span> –í—Ä–µ–º—è (—á—á:–º–º:—Å—Å)</label>
        <div class="inputs">
          <div class="group">
            <input id="hours" type="number" inputmode="numeric" min="0" step="1" placeholder="—á—á" aria-label="–ß–∞—Å—ã" />
          </div>
          <div class="group">
            <input id="minutes" type="number" inputmode="numeric" min="0" max="59" step="1" placeholder="–º–º" aria-label="–ú–∏–Ω—É—Ç—ã" />
          </div>
          <div class="group">
            <input id="seconds" type="number" inputmode="numeric" min="0" max="59" step="1" placeholder="—Å—Å" aria-label="–°–µ–∫—É–Ω–¥—ã" />
          </div>
        </div>
      </section>

      <!-- –¢–µ–º–ø 100–º: –º:—Å -->
      <section class="field row-2">
        <label><span>üèä‚Äç‚ôÄÔ∏è</span> –¢–µ–º–ø –Ω–∞ 100–º (–º–∏–Ω:—Å–µ–∫)</label>
        <div class="inputs">
          <div class="group">
            <input id="p100_min" type="number" inputmode="numeric" min="0" max="59" step="1" placeholder="–º–∏–Ω" aria-label="–ú–∏–Ω—É—Ç—ã –Ω–∞ 100–º" />
            <span class="sep">:</span>
            <input id="p100_sec" type="number" inputmode="numeric" min="0" max="59" step="1" placeholder="—Å–µ–∫" aria-label="–°–µ–∫—É–Ω–¥—ã –Ω–∞ 100–º" />
          </div>
        </div>
      </section>

      <!-- –¢–µ–º–ø –∫–º: –º:—Å -->
      <section class="field row-2">
        <label><span>üèÉ‚Äç‚ôÇÔ∏èüö¥</span> –¢–µ–º–ø –Ω–∞ 1–∫–º (–º–∏–Ω:—Å–µ–∫)</label>
        <div class="inputs">
          <div class="group">
            <input id="pkm_min" type="number" inputmode="numeric" min="0" max="59" step="1" placeholder="–º–∏–Ω" aria-label="–ú–∏–Ω—É—Ç—ã –Ω–∞ –∫–º" />
            <span class="sep">:</span>
            <input id="pkm_sec" type="number" inputmode="numeric" min="0" max="59" step="1" placeholder="—Å–µ–∫" aria-label="–°–µ–∫—É–Ω–¥—ã –Ω–∞ –∫–º" />
          </div>
        </div>
      </section>

      <!-- –°–∫–æ—Ä–æ—Å—Ç—å –∫–º/—á -->
      <section class="field row-1">
        <label for="speed"><span>‚ö°</span> –°–∫–æ—Ä–æ—Å—Ç—å (–∫–º/—á)</label>
        <div class="inputs">
          <div class="group">
            <input id="speed" type="text" inputmode="decimal" placeholder="0.00" aria-label="–°–∫–æ—Ä–æ—Å—Ç—å, –∫–º/—á" />
          </div>
        </div>
      </section>

      <div id="msg" class="message" aria-live="polite"></div>

      <div class="footer">
        <button type="button" class="btn" id="done">‚úÖ –ì–æ—Ç–æ–≤–æ</button>
        <button type="button" class="btn btn-secondary" id="clear">üîÑ –û—á–∏—Å—Ç–∏—Ç—å</button>
        <div class="hint">–í—Å–µ –ø–æ–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ. –î–ª—è —Ä–∞—Å—á—ë—Ç–∞ —É–∫–∞–∂–∏—Ç–µ –º–∏–Ω–∏–º—É–º 2 –ø–∞—Ä–∞–º–µ—Ç—Ä–∞.</div>
      </div>
    </form>
  </main>

  <script>
    // === URL backend'–∞, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç ===
    const BACKEND_URL = "https://pacecalculator-chernaletski.amvera.io/pace-result";

    // Telegram Mini App –æ–±—ä–µ–∫—Ç (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –≤–Ω—É—Ç—Ä–∏ Telegram)
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if (tg) {
      tg.ready();
      if (typeof tg.expand === "function") {
        tg.expand();
      }
    }

    // –ü–æ–ª—É—á–∞–µ–º query-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL: ?chat_id=...&message_id=...&user_id=...
    // (–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ fallback –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –≤ –æ–±—ã—á–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ)
    function getQueryParams() {
      const params = {};
      const query = window.location.search.substring(1);
      if (!query) return params;
      for (const part of query.split("&")) {
        const [key, value] = part.split("=");
        if (!key) continue;
        params[decodeURIComponent(key)] = value ? decodeURIComponent(value) : "";
      }
      return params;
    }

    const tgContext = getQueryParams();
    console.log("Telegram context (query):", tgContext);
    if (tg && tg.initDataUnsafe) {
      console.log("initDataUnsafe:", tg.initDataUnsafe);
    }

    let isUpdating = false;
    let lastEdited = null; // 'D' | 'T' | 'P100' | 'PKM' | 'V'

    const el = {
      distance: document.getElementById("distance"),
      hours: document.getElementById("hours"),
      minutes: document.getElementById("minutes"),
      seconds: document.getElementById("seconds"),
      p100_min: document.getElementById("p100_min"),
      p100_sec: document.getElementById("p100_sec"),
      pkm_min: document.getElementById("pkm_min"),
      pkm_sec: document.getElementById("pkm_sec"),
      speed: document.getElementById("speed"),
      msg: document.getElementById("msg"),
      done: document.getElementById("done"),
      clear: document.getElementById("clear"),
    };

    const num = (v) => {
      if (v === "" || v === null || v === undefined) return null;
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    };

    function sanitizeIntInput(input, min, max) {
      let v = input.value.trim();
      v = v.replace(/[^\d]/g, "");
      if (v === "") {
        input.value = "";
        return null;
      }
      let n = parseInt(v, 10);
      if (!Number.isFinite(n)) {
        input.value = "";
        return null;
      }
      if (min !== undefined && n < min) n = min;
      if (max !== undefined && n > max) n = max;
      input.value = String(n);
      return n;
    }

    function sanitizeDecimalInput(input, min) {
      let v = input.value.trim();
      if (!v) {
        input.value = "";
        return null;
      }
      v = v.replace(",", ".");
      const parts = v.split(".");
      if (parts.length > 2) {
        v = parts[0] + "." + parts.slice(1).join("");
      }
      v = v.replace(/[^0-9.]/g, "");
      input.value = v;
      const n = parseFloat(v);
      if (!Number.isFinite(n)) return null;
      if (min !== undefined && n < min) return null;
      return n;
    }

    function readState() {
      const D = sanitizeDecimalInput(el.distance, 0);

      const hhRaw = sanitizeIntInput(el.hours, 0, 999);
      const mmRaw = sanitizeIntInput(el.minutes, 0, 59);
      const ssRaw = sanitizeIntInput(el.seconds, 0, 59);
      const hasAnyTime = hhRaw !== null || mmRaw !== null || ssRaw !== null;
      const hh = hhRaw ?? 0;
      const mm = mmRaw ?? 0;
      const ss = ssRaw ?? 0;
      const Tsec = hasAnyTime ? hh * 3600 + mm * 60 + ss : null;

      const p100mRaw = sanitizeIntInput(el.p100_min, 0, 59);
      const p100sRaw = sanitizeIntInput(el.p100_sec, 0, 59);
      const hasP100 = p100mRaw !== null || p100sRaw !== null;
      const p100m = p100mRaw ?? 0;
      const p100s = p100sRaw ?? 0;
      const P100 = hasP100 ? p100m * 60 + p100s : null;

      const pkmMRaw = sanitizeIntInput(el.pkm_min, 0, 59);
      const pkmSRaw = sanitizeIntInput(el.pkm_sec, 0, 59);
      const hasPKM = pkmMRaw !== null || pkmSRaw !== null;
      const pkmM = pkmMRaw ?? 0;
      const pkmS = pkmSRaw ?? 0;
      const PKM = hasPKM ? pkmM * 60 + pkmS : null;

      const V = sanitizeDecimalInput(el.speed, 0);

      return {
        D,
        Tsec,
        P100,
        PKM,
        V,
        hasD: D !== null,
        hasT: Tsec !== null,
        hasP100,
        hasPKM,
        hasV: V !== null,
      };
    }

    function setDistance(D) {
      if (el.distance === document.activeElement) return;
      el.distance.value = (D ?? 0).toFixed(2);
    }
    function setTime(Tsec) {
      if ([el.hours, el.minutes, el.seconds].includes(document.activeElement)) return;
      const t = Math.max(0, Math.round(Tsec ?? 0));
      const hh = Math.floor(t / 3600);
      const mm = Math.floor((t % 3600) / 60);
      const ss = t % 60;
      el.hours.value = String(hh);
      el.minutes.value = String(mm);
      el.seconds.value = String(ss);
    }
    function setP100(seconds) {
      if ([el.p100_min, el.p100_sec].includes(document.activeElement)) return;
      const s = Math.max(0, Math.round(seconds ?? 0));
      const m = Math.floor(s / 60);
      const sec = s % 60;
      el.p100_min.value = String(m);
      el.p100_sec.value = String(sec);
    }
    function setPKM(seconds) {
      if ([el.pkm_min, el.pkm_sec].includes(document.activeElement)) return;
      const s = Math.max(0, Math.round(seconds ?? 0));
      const m = Math.floor(s / 60);
      const sec = s % 60;
      el.pkm_min.value = String(m);
      el.pkm_sec.value = String(sec);
    }
    function setSpeed(V) {
      if (el.speed === document.activeElement) return;
      el.speed.value = (V ?? 0).toFixed(2);
    }

    function showMsg(text, type = "") {
      el.msg.textContent = text || "";
      el.msg.classList.remove("ok", "error");
      if (type) el.msg.classList.add(type);
    }

    function compute() {
      if (isUpdating) return;
      isUpdating = true;

      const s = readState();
      const count = ["hasD", "hasT", "hasP100", "hasPKM", "hasV"].reduce(
        (acc, k) => acc + (s[k] ? 1 : 0),
        0
      );

      if (count < 2) {
        showMsg("–£–∫–∞–∂–∏—Ç–µ –º–∏–Ω–∏–º—É–º –¥–≤–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞.", "error");
        isUpdating = false;
        return;
      }

      if (s.D !== null && s.D > 1000) {
        showMsg("–î–∏—Å—Ç–∞–Ω—Ü–∏—è —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è (–º–∞–∫—Å–∏–º—É–º 1000 –∫–º).", "error");
        isUpdating = false;
        return;
      }
      if (s.V !== null && s.V > 100) {
        showMsg("–°–∫–æ—Ä–æ—Å—Ç—å —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è (–º–∞–∫—Å–∏–º—É–º 100 –∫–º/—á).", "error");
        isUpdating = false;
        return;
      }

      let { D, Tsec: T, P100, PKM, V } = s;
      let solved = false;

      function useDT() {
        if (s.hasD && s.hasT && s.D > 0 && s.Tsec > 0) {
          D = s.D;
          T = s.Tsec;
          PKM = T / D;
          P100 = PKM / 10;
          V = D / (T / 3600);
          solved = true;
        }
      }
      function useDP100() {
        if (s.hasD && s.hasP100 && s.D > 0 && s.P100 > 0) {
          D = s.D;
          P100 = s.P100;
          PKM = P100 * 10;
          T = D * PKM;
          V = D / (T / 3600);
          solved = true;
        }
      }
      function useDPKM() {
        if (s.hasD && s.hasPKM && s.D > 0 && s.PKM > 0) {
          D = s.D;
          PKM = s.PKM;
          T = D * PKM;
          P100 = PKM / 10;
          V = 3600 / PKM;
          solved = true;
        }
      }
      function useDV() {
        if (s.hasD && s.hasV && s.D > 0 && s.V > 0) {
          D = s.D;
          V = s.V;
          T = (D / V) * 3600;
          PKM = 3600 / V;
          P100 = PKM / 10;
          solved = true;
        }
      }
      function useTP100() {
        if (s.hasT && s.hasP100 && s.Tsec > 0 && s.P100 > 0) {
          T = s.Tsec;
          P100 = s.P100;
          PKM = P100 * 10;
          D = T / PKM;
          V = D / (T / 3600);
          solved = true;
        }
      }
      function useTPKM() {
        if (s.hasT && s.hasPKM && s.Tsec > 0 && s.PKM > 0) {
          T = s.Tsec;
          PKM = s.PKM;
          D = T / PKM;
          P100 = PKM / 10;
          V = 3600 / PKM;
          solved = true;
        }
      }
      function useTV() {
        if (s.hasT && s.hasV && s.Tsec > 0 && s.V > 0) {
          T = s.Tsec;
          V = s.V;
          D = V * (T / 3600);
          PKM = 3600 / V;
          P100 = PKM / 10;
          solved = true;
        }
      }

      switch (lastEdited) {
        case "D":
          useDT();
          if (!solved) useDP100();
          if (!solved) useDPKM();
          if (!solved) useDV();
          break;
        case "T":
          useDT();
          if (!solved) useTP100();
          if (!solved) useTPKM();
          if (!solved) useTV();
          break;
        case "P100":
          useDP100();
          if (!solved) useTP100();
          if (!solved && s.hasPKM) {
            P100 = s.P100;
            PKM = P100 * 10;
            if (s.hasV && s.V > 0) {
              V = 3600 / PKM;
            }
            solved = true;
          }
          if (!solved && s.hasV && s.V > 0) {
            P100 = s.P100;
            PKM = P100 * 10;
            V = 3600 / PKM;
            solved = true;
          }
          break;
        case "PKM":
          useDPKM();
          if (!solved) useTPKM();
          if (!solved && s.hasP100) {
            PKM = s.PKM;
            P100 = PKM / 10;
            if (s.hasV && s.V > 0) {
              V = 3600 / PKM;
            }
            solved = true;
          }
          if (!solved && s.hasV && s.V > 0) {
            PKM = s.PKM;
            V = 3600 / PKM;
            P100 = PKM / 10;
            solved = true;
          }
          break;
        case "V":
          useDV();
          if (!solved) useTV();
          if (!solved && s.hasPKM) {
            V = s.V;
            PKM = 3600 / V;
            P100 = PKM / 10;
            solved = true;
          }
          if (!solved && s.hasP100) {
            V = s.V;
            PKM = 3600 / V;
            P100 = PKM / 10;
            solved = true;
          }
          break;
        default:
          useDT();
          if (!solved) useDP100();
          if (!solved) useDPKM();
          if (!solved) useDV();
          if (!solved) useTP100();
          if (!solved) useTPKM();
          if (!solved) useTV();
      }

      if (!solved) {
        if (s.hasPKM && !s.hasP100) {
          PKM = s.PKM;
          P100 = PKM / 10;
          solved = true;
          showMsg(
            "–î–æ–±–∞–≤—å—Ç–µ –¥–∏—Å—Ç–∞–Ω—Ü–∏—é –∏–ª–∏ –≤—Ä–µ–º—è, —á—Ç–æ–±—ã –ø–æ—Å—á–∏—Ç–∞—Ç—å –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ.",
            "ok"
          );
        } else if (s.hasP100 && !s.hasPKM) {
          P100 = s.P100;
          PKM = P100 * 10;
          solved = true;
          showMsg(
            "–î–æ–±–∞–≤—å—Ç–µ –¥–∏—Å—Ç–∞–Ω—Ü–∏—é –∏–ª–∏ –≤—Ä–µ–º—è, —á—Ç–æ–±—ã –ø–æ—Å—á–∏—Ç–∞—Ç—å –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ.",
            "ok"
          );
        } else if (s.hasV && !s.hasPKM && !s.hasP100) {
          V = s.V;
          PKM = 3600 / V;
          P100 = PKM / 10;
          solved = true;
          showMsg(
            "–î–æ–±–∞–≤—å—Ç–µ –¥–∏—Å—Ç–∞–Ω—Ü–∏—é –∏–ª–∏ –≤—Ä–µ–º—è, —á—Ç–æ–±—ã –ø–æ—Å—á–∏—Ç–∞—Ç—å –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ.",
            "ok"
          );
        } else {
          showMsg(
            "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞. –£—Ç–æ—á–Ω–∏—Ç–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏—é.",
            "error"
          );
        }
      }

      if (s.hasP100 && s.hasPKM) {
        const expectedPKM = s.P100 * 10;
        if (Math.abs(s.PKM - expectedPKM) > 2) {
          if (lastEdited === "P100") {
            PKM = expectedPKM;
          } else if (lastEdited === "PKM") {
            P100 = s.PKM / 10;
          }
        }
      }

      if (solved) {
        if (Number.isFinite(D)) setDistance(D);
        if (Number.isFinite(T)) setTime(T);
        if (Number.isFinite(P100)) setP100(P100);
        if (Number.isFinite(PKM)) setPKM(PKM);
        if (Number.isFinite(V)) setSpeed(V);
        if (!el.msg.textContent || el.msg.classList.contains("error")) {
          showMsg("–†–∞—Å—á—ë—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ.", "ok");
        }
      }

      isUpdating = false;
    }

    function onEdit(category) {
      lastEdited = category;
      compute();
    }

    el.distance.addEventListener("input", () => onEdit("D"));
    [el.hours, el.minutes, el.seconds].forEach((i) =>
      i.addEventListener("input", () => onEdit("T"))
    );
    [el.p100_min, el.p100_sec].forEach((i) =>
      i.addEventListener("input", () => onEdit("P100"))
    );
    [el.pkm_min, el.pkm_sec].forEach((i) =>
      i.addEventListener("input", () => onEdit("PKM"))
    );
    el.speed.addEventListener("input", () => onEdit("V"));

    el.clear.addEventListener("click", () => {
      isUpdating = true;
      [
        el.distance,
        el.hours,
        el.minutes,
        el.seconds,
        el.p100_min,
        el.p100_sec,
        el.pkm_min,
        el.pkm_sec,
        el.speed,
      ].forEach((inp) => (inp.value = ""));
      lastEdited = null;
      isUpdating = false;
      showMsg("");
    });

    // –ö–Ω–æ–ø–∫–∞ "–ì–æ—Ç–æ–≤–æ" ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –Ω–∞ backend + –∑–∞–∫—Ä—ã—Ç–∏–µ Mini App
    el.done.addEventListener("click", async () => {
      const s = readState();
      const count = ["hasD", "hasT", "hasP100", "hasPKM", "hasV"].reduce(
        (acc, k) => acc + (s[k] ? 1 : 0),
        0
      );
      if (count < 2) {
        alert("–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º—É–º –¥–≤–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π.");
        return;
      }

      // 1) –ü—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å chat_id / user_id –∏–∑ Mini App initDataUnsafe
      let chatId = null;
      let userId = null;

      if (tg && tg.initDataUnsafe) {
        if (
          tg.initDataUnsafe.chat &&
          typeof tg.initDataUnsafe.chat.id === "number"
        ) {
          chatId = tg.initDataUnsafe.chat.id;
        }
        if (
          tg.initDataUnsafe.user &&
          typeof tg.initDataUnsafe.user.id === "number"
        ) {
          userId = tg.initDataUnsafe.user.id;
        }
      }

      // 2) –ï—Å–ª–∏ Mini App‚Äë–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –Ω–µ—Ç (–æ—Ç–∫—Ä—ã—Ç–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ) ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º query‚Äë–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–∞–∫ —Ä–∞–Ω—å—à–µ
      if (!chatId && (!tg || !tg.initDataUnsafe)) {
        chatId =
          tgContext.chat_id && tgContext.chat_id !== "None"
            ? Number(tgContext.chat_id)
            : null;
        userId =
          tgContext.user_id && tgContext.user_id !== "None"
            ? Number(tgContext.user_id)
            : null;
      }

      const result = {
        distanceKm: s.D ?? null,
        time: (() => {
          if (!s.hasT) return null;
          const t = s.Tsec;
          const hh = Math.floor(t / 3600);
          const mm = Math.floor((t % 3600) / 60);
          const ss = t % 60;
          return {
            hours: hh,
            minutes: mm,
            seconds: ss,
            totalSeconds: t,
          };
        })(),
        pace100m: s.hasP100
          ? {
              minutes: Math.floor(s.P100 / 60),
              seconds: s.P100 % 60,
              totalSeconds: s.P100,
            }
          : null,
        pacePerKm: s.hasPKM
          ? {
              minutes: Math.floor(s.PKM / 60),
              seconds: s.PKM % 60,
              totalSeconds: s.PKM,
            }
          : null,
        speedKmh: s.V ?? null,
        timestamp: new Date().toISOString(),
        chat_id: chatId,
        user_id: userId,
      };

      console.log("–û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –Ω–∞ backend:", result);

      try {
        const resp = await fetch(BACKEND_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(result),
        });

        if (!resp.ok) {
          throw new Error("HTTP " + resp.status);
        }

        const data = await resp.json().catch(() => ({}));
        console.log("–û—Ç–≤–µ—Ç backend:", data);

        if (data && data.status === "ok") {
          if (tg && typeof tg.close === "function") {
            tg.close(); // –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ Mini App [file:1]
          } else {
            alert("–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —á–∞—Ç ‚úÖ");
          }
        } else {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –ø–æ–∑–∂–µ.");
        }
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ backend:", e);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –ø–æ–∑–∂–µ.");
      }
    });

    compute();
  </script>
</body>
</html>
